<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>quick-pomelo by memdb</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>quick-pomelo</h1>
        <h2>Scalable, transactional and reliable game server framework based on Pomelo and MemDB</h2>
        <a href="https://github.com/memdb/quick-pomelo" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <ul>
<li><p><strong>Horizontally Scalable</strong> : Performance grows linearly by adding more servers.</p></li>
<li><p><strong>ACID Transaction</strong> : Full <a href="https://en.wikipedia.org/wiki/ACID">ACID</a> transaction support on distributed environment.</p></li>
<li><p><strong>High Availability</strong> : Each server is backed by one or more replica, you will never lose any committed data.</p></li>
<li><p><strong>'MVC' Architecture</strong> : Define data model using 'mongoose'.</p></li>
</ul>

<h3>
<a id="the-wiki" class="anchor" href="#the-wiki" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/memdb/quick-pomelo/wiki">The Wiki</a>
</h3>

<h3>
<a id="demo-game斗地主" class="anchor" href="#demo-game%E6%96%97%E5%9C%B0%E4%B8%BB" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/memdb/quick-pomelo-demo">Demo Game(斗地主)</a>
</h3>

<h2>
<a id="quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Start</h2>

<h3>
<a id="prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites</h3>

<h4>
<a id="pomelo" class="anchor" href="#pomelo" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/NetEase/pomelo">Pomelo</a>
</h4>

<p>Quick-pomelo is based on pomelo, have a draft idea of pomelo framework is required.</p>

<h4>
<a id="memdb" class="anchor" href="#memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/memdb/memdb">MemDB</a>
</h4>

<p>Quick-pomelo use memdb for underlaying data storage, so understanding memdb is required.</p>

<h3>
<a id="install-dependencies" class="anchor" href="#install-dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install dependencies</h3>

<ul>
<li>Install <a href="https://nodejs.org/download">Node.js</a>
</li>
<li>Install <a href="http://redis.io/download">Redis</a> (required for memdb)</li>
<li>Install <a href="https://www.mongodb.org/downloads">MongoDB</a> (required for memdb)</li>
<li>Install <a href="https://github.com/memdb/memdb">MemDB</a>
</li>
</ul>

<pre><code>sudo npm install -g memdb-server
</code></pre>

<h3>
<a id="start-with-template" class="anchor" href="#start-with-template" aria-hidden="true"><span class="octicon octicon-link"></span></a>Start with template</h3>

<p>First copy the template to your working directory. The template contains most common skeletons for a quick-pomelo game server.</p>

<h3>
<a id="define-models" class="anchor" href="#define-models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Define models</h3>

<p>Define data models in app/models directory</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// app/models/player.js</span>
<span class="pl-c1">module</span>.<span class="pl-en">exports</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">app</span>){
    <span class="pl-k">var</span> mdbgoose <span class="pl-k">=</span> app.memdb.goose;

    <span class="pl-k">var</span> PlayerSchema <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">mdbgoose.Schema</span>({
        _id <span class="pl-k">:</span> {type <span class="pl-k">:</span> <span class="pl-c1">String</span>},
        areaId <span class="pl-k">:</span> {type <span class="pl-k">:</span> <span class="pl-c1">String</span>},
        teamId <span class="pl-k">:</span> {type <span class="pl-k">:</span> <span class="pl-c1">String</span>},
        connectorId <span class="pl-k">:</span> {type <span class="pl-k">:</span> <span class="pl-c1">String</span>},
        name <span class="pl-k">:</span> {type <span class="pl-k">:</span> <span class="pl-c1">String</span>},
    }, {collection <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>players<span class="pl-pds">'</span></span>});

    mdbgoose.model(<span class="pl-s"><span class="pl-pds">'</span>Player<span class="pl-pds">'</span></span>, PlayerSchema);
};</pre></div>

<h3>
<a id="write-controllers" class="anchor" href="#write-controllers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Write controllers</h3>

<p>Write controllers in app/controllers directory</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// app/controllers/player.js</span>
<span class="pl-k">var</span> <span class="pl-en">Controller</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">app</span>){
    <span class="pl-v">this</span>.app <span class="pl-k">=</span> app;
};

<span class="pl-k">var</span> proto <span class="pl-k">=</span> Controller.<span class="pl-c1">prototype</span>;

<span class="pl-c1">proto</span>.<span class="pl-en">createPlayerAsync</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">opts</span>){
    <span class="pl-c">// Get model by this.app.models.[model]</span>
    <span class="pl-k">var</span> player <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">this.app</span>.models.Player(opts);
    <span class="pl-k">yield</span> player.saveAsync();
};

<span class="pl-c1">proto</span>.<span class="pl-en">removePlayerAsync</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">playerId</span>){
    <span class="pl-k">var</span> player <span class="pl-k">=</span> <span class="pl-k">yield</span> <span class="pl-v">this</span>.app.models.Player.findAsync(playerId);
    <span class="pl-k">if</span>(<span class="pl-k">!</span>player){
        <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>player not exist<span class="pl-pds">'</span></span>);
    }
    <span class="pl-k">yield</span> player.removeAsync();
};

<span class="pl-c1">module</span>.<span class="pl-en">exports</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">app</span>){
    <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-en">Controller</span>(app);
};</pre></div>

<h3>
<a id="define-routes" class="anchor" href="#define-routes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Define routes</h3>

<p>For each type of server, write a route in app/routes directory.</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// app/routes/player.js</span>
<span class="pl-c1">module</span>.exports <span class="pl-k">=</span> {
    <span class="pl-c">// Routing in handler</span>
    <span class="pl-en">handler</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">session</span>, <span class="pl-smi">method</span>, <span class="pl-smi">msg</span>){
        <span class="pl-c">// Return a string routing key</span>
        <span class="pl-c">// Same routing key always route to the same backend server.</span>
        <span class="pl-k">return</span> session.uid <span class="pl-k">||</span> msg.playerId;
    },
    <span class="pl-c">// Routing in remote</span>
    <span class="pl-en">remote</span> <span class="pl-k">:</span> <span class="pl-k">function</span>(<span class="pl-smi">routeParam</span>, <span class="pl-smi">method</span>, <span class="pl-smi">args</span>){
        <span class="pl-k">return</span> routeParam;
    }
};</pre></div>

<h3>
<a id="write-server-handlers" class="anchor" href="#write-server-handlers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Write server handlers</h3>

<p>Write server handlers in app/servers/[server]/handler</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// app/servers/player/playerHandler.js</span>
<span class="pl-k">var</span> <span class="pl-en">Handler</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">app</span>){
    <span class="pl-v">this</span>.app <span class="pl-k">=</span> app;
};

<span class="pl-c1">Handler</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">createPlayer</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>){
    <span class="pl-c">// Get controller by this.app.controllers.[controler]</span>
    <span class="pl-k">return</span> <span class="pl-v">this</span>.app.<span class="pl-c1">controllers</span>.player.createPlayerAsync(msg.opts)
    .nodeify(next); 
};

<span class="pl-c1">module</span>.<span class="pl-en">exports</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">app</span>){
    <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-en">Handler</span>(app);
};</pre></div>

<h3>
<a id="start-server" class="anchor" href="#start-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Start server</h3>

<p>Start memdb cluster</p>

<pre><code>memdbcluster start --conf=[memdb.conf.js]
</code></pre>

<p>Start quick pomelo server</p>

<pre><code>pomelo start
</code></pre>

<h3>
<a id="well-done-congratulations" class="anchor" href="#well-done-congratulations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Well done! Congratulations!</h3>

<h2>
<a id="quicks-philosophy" class="anchor" href="#quicks-philosophy" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick's Philosophy</h2>

<p>A typical realtime game server framework is stateful for the sake of performance, all states is kept in server local memory. However, this approach has significant drawbacks:</p>

<ul>
<li>Any exceptions (may be caused by bugs or unexpected client input) may result in non-consistent state (half-modified dirty data), which is very difficult to recover</li>
<li>Concurrency control is very difficult to implement</li>
<li>We must remember which server the data is located, and use rpc to get data, which is error prone.</li>
<li>In memory data will be lost on server failure, it's very difficult to support HA</li>
</ul>

<p>Thanks to <a href="http://memdb.org">MemDB</a>, quick pomelo un-invent the stateful approach and use a web server like 'MVC' based architecture. All servers become stateless and all states is stored in memdb. You can now get all benefits from a typical stateless web server, without losing performance and scalability of in memory stateful server.</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright 2015 MemDB.</p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing
permissions and limitations under the License. See the AUTHORS file
for names of contributors.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/memdb/quick-pomelo/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/memdb/quick-pomelo/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/memdb/quick-pomelo"></a> is maintained by <a href="https://github.com/memdb">memdb</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-65398000-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
